<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Report Generator - Dashboard</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <!-- Background Elements -->
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>

    <div class="container">
        <header>
            <h1><i class="fa-solid fa-robot"></i> AI Report Generator</h1>
            <p class="subtitle">Dashboard quản lý và tạo báo cáo đầu tư tự động</p>
        </header>

        <div class="grid">
            <!-- Check API Key -->
            <div class="card">
                <h3><i class="fa-solid fa-key" style="color: #f43f5e;"></i> API Key</h3>
                <p>Kiểm tra trạng thái kết nối và cấu hình API key của hệ thống.</p>
                <div style="margin-top: auto;">
                    <button class="btn-info" onclick="checkApiKey()">
                        <i class="fa-solid fa-check-circle"></i> Kiểm tra
                    </button>
                </div>
            </div>

            <!-- Scheduler Status -->
            <div class="card">
                <h3><i class="fa-solid fa-clock" style="color: #3b82f6;"></i> Scheduler</h3>
                <p>Xem trạng thái và cấu hình của trình lập lịch báo cáo tự động.</p>
                <div style="margin-top: auto;">
                    <button class="btn-info" onclick="getSchedulerStatus()">
                        <i class="fa-solid fa-eye"></i> Xem trạng thái
                    </button>
                </div>
            </div>

            <!-- Generate Auto Report -->
            <div class="card">
                <h3><i class="fa-solid fa-rocket" style="color: #a855f7;"></i> Auto Report</h3>
                <p>Kích hoạt quy trình tạo báo cáo AI đầy đủ (chạy ngầm).</p>
                <div style="margin-top: auto;">
                    <button class="btn-primary" onclick="generateAutoReport()">
                        <i class="fa-solid fa-play"></i> Bắt đầu
                    </button>
                </div>
            </div>

            <!-- Manual Generate -->
            <div class="card">
                <h3><i class="fa-solid fa-pen-to-square" style="color: #f97316;"></i> Manual Report</h3>
                <p>Tạo báo cáo nhanh ngay lập tức (không chạy ngầm).</p>
                <div style="margin-top: auto;">
                    <button class="btn-secondary" onclick="generateManualReport()">
                        <i class="fa-solid fa-bolt"></i> Tạo ngay
                    </button>
                </div>
            </div>

            <!-- Get Progress -->
            <div class="card">
                <h3><i class="fa-solid fa-chart-line" style="color: #2dd4bf;"></i> Tiến độ</h3>
                <p>Theo dõi trạng thái xử lý của các session đang chạy.</p>
                <div style="margin-top: auto;">
                    <div class="progress-input">
                        <input type="text" id="sessionId" placeholder="Nhập Session ID...">
                        <button class="btn-info" onclick="getProgress()" style="width: auto; padding: 12px 20px;">
                            <i class="fa-solid fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Đang xử lý dữ liệu với AI...</p>
        </div>

        <div class="result-container" id="resultContainer" style="display: none;">
            <h3><i class="fa-solid fa-terminal"></i> Kết quả xử lý</h3>
            <div class="result" id="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1';

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultContainer').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showResult(data, isError = false) {
            hideLoading();
            const container = document.getElementById('resultContainer');
            const result = document.getElementById('result');
            container.style.display = 'block';

            // Scroll to result
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });

            if (isError) {
                result.innerHTML = `<span class="error"><i class="fa-solid fa-circle-xmark"></i> Lỗi:</span>\n${JSON.stringify(data, null, 2)}`;
                result.style.borderLeftColor = '#f43f5e';
            } else {
                result.innerHTML = `<span class="success"><i class="fa-solid fa-circle-check"></i> Thành công:</span>\n${JSON.stringify(data, null, 2)}`;
                result.style.borderLeftColor = '#4ade80';
            }
        }

        async function checkApiKey() {
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/check-api-key`);
                const data = await response.json();
                showResult(data);
            } catch (error) {
                showResult({ error: error.message }, true);
            }
        }

        async function getSchedulerStatus() {
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/scheduler/status`);
                const data = await response.json();
                showResult(data);
            } catch (error) {
                showResult({ error: error.message }, true);
            }
        }

        async function generateAutoReport() {
            if (!confirm('Bạn có chắc muốn tạo báo cáo tự động? Quá trình này sẽ chạy trong background.')) {
                return;
            }

            showLoading();
            try {
                const response = await fetch(`${API_BASE}/generate-auto-report`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                if (data.session_id) {
                    document.getElementById('sessionId').value = data.session_id;
                }

                showResult(data, !data.success);
            } catch (error) {
                showResult({ error: error.message }, true);
            }
        }

        async function generateManualReport() {
            if (!confirm('Bạn có chắc muốn tạo báo cáo thủ công? Quá trình này có thể mất vài phút.')) {
                return;
            }

            showLoading();
            try {
                const response = await fetch(`${API_BASE}/manual-generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                showResult(data, !data.success);
            } catch (error) {
                showResult({ error: error.message }, true);
            }
        }

        async function getProgress() {
            const sessionId = document.getElementById('sessionId').value.trim();

            if (!sessionId) {
                alert('Vui lòng nhập session ID');
                return;
            }

            showLoading();
            try {
                const response = await fetch(`${API_BASE}/progress/${sessionId}`);
                const data = await response.json();
                showResult(data, response.status !== 200);
            } catch (error) {
                showResult({ error: error.message }, true);
            }
        }
    </script>
</body>

</html>